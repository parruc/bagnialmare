{% extends "base.html" %}

{% load l10n i18n query_string %}
{% load batch from custom_filters %}

{% block content %}
{% trans "what" as t_what %}
{% trans "where" as t_where %}
{% trans "search" as t_search %}
{% trans "bagno" as t_bagno %}
{% trans "filter_by_facility" as t_filter_by_facility %}
{% trans "active_filters" as t_active_filters %}
{% trans "results_for" as t_results_for %}
{% trans "results" as t_results %}
{% trans "near_to" as t_near_to %}
{% trans "filters" as t_filters%}
{% trans "list_view" as t_list_view %}
{% trans "map_view" as t_map_view %}
{% trans "contact_button" as t_contact_button %}
{% trans "previous" as t_previous %}
{% trans "next" as t_next %}
{% trans "first" as t_first %}
{% trans "last" as t_last %}
{% trans "no_results_for_search" as t_no_results_for_search %}


  <div id="contact-form"></div>
  <div id="wrapped">
    {% comment %}
 html - Twitter Bootstrap 3 inline and horizontal form - Stack Overflow       TODO: Da rifattorizzare in un templatetag da usare sia qui che in hp?
    {% endcomment %}
    <div class="search-page-search-row-wrapper-div hidden-xs">
      <div class="row search search-page-search-row">
        <form role="form" action="{% url 'search' %}" method="get">
          <input type="hidden" name="pos" value="" />
          <div class="col-xs-5">
              <label class="my-brown" for="search_q">{{ t_what|capfirst }}</label>
            <input class="form-control" type="text" id="search_q"
                   name="q" value="{{ search_results.q }}" />
          </div>
          <div class="col-xs-5">
              <label class="my-brown" for="search_l">{{ t_where|capfirst }}</label>
            <input class="form-control" type="text" id="search_l"
                   name="l" value="{{ search_results.l }}"  />
          </div>
          <div class="col-xs-2 search-page-search-button-div">
            <button type="submit" id="search_submit"
                    class="btn btn-primary search-page-button" value="search">
              {{ t_search|capfirst }}
            </button>
          </div>
        </form>
      </div><!--row search-->
    </div>

    {% if search_results.has_get %}
      <div class="row result-wrapper-div">
        <div class="col-sm-3 hidden-xs">
          <div id="filters" data-base-url="{% url 'search' %}">
            {% if search_results.facets.items %}
              <h3 class="filter-result-header">{{ t_filter_by_facility|capfirst }}:</h3>
            {% endif %}
            {% for facet in search_results.active_facets %}
              {% if forloop.first %}
                <h4 class="filter-result-service-category"
                    data-toggle="collapse"
                    data-target="#collapse_active">
                  <span id="collapse_active"
                        class="glyphicon glyphicon-chevron-down facility-categoty-arrow"></span>
                    {{ t_active_filters|capfirst }}
                </h4>
                <div class="collapse in" >
                  <ul class="list-group">
              {% endif %}
              <div class="checkbox filter-result-selected-checkbox-div">
                <label class="filter-result-selected-checkbox-label">
                  <input data-facet-url="?{{ facet.url }}"
                         type="checkbox" checked />
                  {{ facet.name }} ({{ facet.group }})
                </label>
              </div>
              {% if forloop.last %}
                  </ul>
                </div>
              {% endif %}
            {% endfor %}
            {% for facet_group in search_results.facets.values %}
              {% if facet_group %}
                <div>
                  <div>
                    <h4 class="filter-result-service-category"
                        data-toggle="collapse"
                        data-target="#collapse{{ forloop.counter }}">
                      <span class="glyphicon glyphicon-chevron-down facility-categoty-arrow"></span>
                      {% filter capfirst %}
                        {% trans facet_group.name %}
                      {% endfilter %}
                    </h4>
                  </div>
                  {% for facet in facet_group.facets %}
                    {% if forloop.first %}
                      <div id="collapse{{ forloop.parentloop.counter }}"
                           class="collapse{% if facet_group.order < 3 %} in{% endif %}" >
                        <ul class="list-group">
                    {% endif %}
                    <li class="list-unstyled">
                      <div class="checkbox filter-result-checkbox-div">
                        <label>
                          <input data-facet-url="?{{ facet.url }}"
                                 type="checkbox" />
                          {{ facet.name }}
                        </label>
                      </div>
                    </li>
                    {% if forloop.last %}
                        </ul>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="col-xs-12 col-sm-9">
          <p>
            <span class="hits-count">{{ search_results.count }}</span>
            {% if search_results.q %}
              {{ t_results_for }}
              <span class="hits-query">{{ search_results.q }}</span>
            {% else %}
              {{ t_results }}
            {% endif %}
            {% if search_results.place %}
              {{ t_near_to }}
              <span class="hits-query">{{ search_results.place }}</span>
            {% endif %}
          </p>
          {% if hits %}
            <ul class="nav nav-tabs search-page-tabs" id="myTab">
              <li class="visible-xs">
                <a href="#filterTab" data-toggle="tab">
                  {{ t_filters|capfirst }}
                </a>
              </li>
              <li class="active">
                <a href="#listTab" data-toggle="tab">
                  {{ t_list_view|capfirst }}
                </a>
              </li>
              <li>
                <a href="#mapTab" data-toggle="tab">
                  {{ t_map_view|capfirst }}
                </a>
              </li>
            </ul>
          {% endif %}
          <div id="content" class="tab-content">
            {% if hits %}
              <div class="tab-pane" id="mapTab">
                <ul id="bagniToBeMapped" class="hide">
                  {%  for hit in hits %}
                    {% if hit.point.x and hit.point.y %}
                      <li data-url= "{{ hit.get_absolute_url }}"
                          data-name = "{{ hit.name }}"
                          data-address = "{{ hit.address }}"
                          data-x = "{{ hit.point.x|unlocalize }}"
                          data-y = "{{ hit.point.y|unlocalize }}" >
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
                <div id="bagno_map" style="width: 100%; height: 500px"></div>
              </div>
              <div class="tab-pane active" id="listTab">
                {%  for hit in hits %}
                  <hr class="search-result-separator" />
                  <div class="single-bagno-result-box">
                    <div class="row">
                      <div class="col-xs-12">
                        <h2 class="single-result-header">
                            <a href="{{ hit.get_absolute_url }}"
                               title="{{ t_bagno }} {{ hit.name }}">
                            {{ hit.name }}, {{ hit.neighbourhood.name }}
                          </a>
                          {% if hit.distance %}
                            <span class="badge">
                              {{hit.distance.km|floatformat:2 }}Km
                            </span>
                          {% endif %}
                        </h2>
                        <p class="single-result-address">
                          {{ hit.address }} -
                          {{ hit.neighbourhood.name }},
                          {{ hit.neighbourhood.municipality.name }} -
                          {{ hit.neighbourhood.municipality.district.name }}
                        </p>
                        {% if hit.is_managed %}
                          <button id="contact-form-button" class="button"
                                  data-url="{{ hit.get_contactform_url }}">
                            {{ t_contact_button }}
                          </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
                <div class="pagination">
                  <span class="step-links">
                    {% if hits.has_previous %}
                      <a href="{% query_string '' 'p' %}">
                        {{ t_first }}
                      </a>
                      <a href="{% query_string 'p=hits.previous_page_number' '' %}">
                        {{ t_previous }}
                      </a>
                    {% endif %}

                    <span class="current">
                      {% blocktrans with num_pages=search_results.num_pages page=hits.number %}
                      Page {{ page }} of {{ num_pages }}.{% endblocktrans %}
                    </span>
                    {% if hits.has_next %}
                      <a href="{% query_string 'p=hits.next_page_number'  '' %}">
                        {{ t_next }}
                      </a>
                      <a href="{% query_string 'p=search_results.num_pages'  '' %}">
                        {{ t_last }}
                      </a>
                    {% endif %}
                  </span>
                </div>
              </div>
            {% else %}
              <div class="tab-pane active" id="listTab">
                {{ t_no_restuls_for_search }}
              </div>
            {% endif %}
            <div class="tab-pane" id="filterTab">
              {% if search_results.facets.items %}
                <h3 class="filter-result-header-tab">
                  {{ t_filter_by_facility }}
                </h3>
              {% endif %}
              {% for facet in search_results.active_facets %}
                {% if forloop.first %}
                  <h4 class="filter-result-service-category"
                      data-toggle="collapse"
                      data-target="#collapse_active">
                    <span id="collapse_active"
                          class="glyphicon glyphicon-chevron-down my-brown"></span>
                      {{ t_active_filters|capfirst }}
                  </h4>
                  <div class="collapse in" >
                    <ul class="list-group">
                {% endif %}
                <div class="checkbox filter-result-selected-checkbox-div">
                  <label class="filter-result-selected-checkbox-label">
                    <input data-facet-url="?{{ facet.url }}"
                           type="checkbox" checked />
                    {{ facet.name }} ({{ facet.group }})
                  </label>
                </div>
                {% if forloop.last %}
                    </ul>
                  </div>
                {% endif %}
              {% endfor %}
              {% for facet_group in search_results.facets.values  %}
                {% if facet_group %}
                  <div>
                    <div>
                      <h4 class="filter-result-service-category"
                          data-toggle="collapse"
                          data-order="{{ facet_group.order }}"
                          data-target="#collapseInsideTab{{ forloop.counter }}">
                        <span class="glyphicon glyphicon-chevron-down my-brown">
                        </span>
                        {% filter capfirst %}{% trans facet_group.name %}{% endfilter %}
                      </h4>
                    </div>
                    {% for facet in facet_group.facets %}
                      {% if forloop.first %}
                        <div id="collapseInsideTab{{ forloop.parentloop.counter }}"
                             class="collapse{% if facet_group.order < 3 %} in{% endif %}" >
                          <ul class="list-group">
                      {% endif %}
                      <li class="list-unstyled">
                        <div class="checkbox filter-result-checkbox-div">
                          <label>
                            <input data-facet-url="?{{ facet.url }}"
                                   type="checkbox" />
                            {{ facet.name }}
                          </label>
                        </div>
                      </li>
                      {% if forloop.last %}
                          </ul>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <div class="modal-wheel"><!-- Place at bottom of page --></div>
    {% endif %}
  </div><!--wrapped-->
{% endblock %}

{% block specific_js %}
  <script type="text/javascript" src="{{ STATIC_URL }}js/geolocation.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/search.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/contact_dialog.js"></script>
{% endblock specific_js %}


{% block title %}
{% trans "search" as t_search %}
{{ t_search|title }}
{% endblock title %}

{% block pagetitle %}
{% trans "search_pagetitle" as t_search_pagetitle %}
{{ t_search_pagetitle|title }}
{% endblock pagetitle %}

{% block description %}
{% trans "search_description" as t_search_description %}
{{ t_search_description }}
{% endblock description %}
