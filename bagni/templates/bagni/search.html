{% extends "base.html" %}

{% load l10n i18n query_string %}
{% load batch from custom_filters %}

{% block content %}
    {% comment %}
 html - Twitter Bootstrap 3 inline and horizontal form - Stack Overflow       TODO: Da rifattorizzare in un templatetag da usare sia qui che in hp?
    {% endcomment %}
    <div class="search-page-search-row-wrapper-div"><div class="row search search-page-search-row">
            <form role="form" action="{% url 'search' %}" method="get">
                    <div class="col-xs-5">
                        <label class="" for="search_q">{% trans 'What' %}:</label>
                        <input class="form-control input-lg"  type="text" id="search_q" name="q" value="{{ q }}" />
                    </div>
                    <div class="col-xs-5">
                        <label class="" for="search_q">{% trans 'Where' %}:</label>
                        <input class="form-control input-lg" type="text" id="search_l" name="l" value="{{ l }}"  />
                    </div>
                    <div class="col-xs-2 search-page-search-button-div">
                        <button type="submit" id="search_submit" class="btn btn-lg btn-primary search-page-button" value="search">{% trans "Search" %}</button>
                    </div> 
            </form>
    </div></div>

    {% if has_get %}
        <div class="row result-wrapper-div">
            <div class="col-xs-3">
                <div class="filter-result-box">
                    {% for facet in active_facets %}
                        {% if forloop.first %}
                            <div class="panel active-filters">
                                <div class="panel-heading">
                                    <h3>{% trans "Active filters" %}</h3>
                                </div>
                                <ul class="list-group">
                        {% endif %}
                            <li class="list-group-item">
                                <a href="?{{ facet.url }}">{% trans facet.group %}: {% trans facet.name %}</a>
                            </li>
                        {% if forloop.last %}
                            </ul>
                        </div>
                        {% endif %}
                    {% endfor %}
                    <h3 class="filter-result-header">{% trans "Filter by facility" %}:</h3>
                    {% for facet_group, facet_values in facets.items %}
                        {% if facet_group %}
                            <div class="">
                                <div class="">
                                    <h4 class="text-underlined">{% trans facet_group %}</h4>
                                </div>
                                {% for facet in facet_values %}
                                    {% if forloop.first %}
                                        <ul class="list-group">
                                    {% endif %}
                                    <li class="list-unstyled">
                                        <div class="checkbox">
                                           <label><input type="checkbox">{{ facet.name }}</label>
                                        </div>
                                    </li>
                                    {% if forloop.last %}
                                        </ul>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="col-xs-9">
                <p>
                    <span class="hits-count">{{ count }}</span>
                    {% if q %}
                        {% trans "results for" %} <span class="hits-query">{{ q }}</span>
                    {% else %}
                        {% trans "results" %}
                    {% endif %}
                    {% if place %}
                        {% trans "near" %} <span class="hits-query">{{ place }}</span>
                    {% endif %}
                </p>
                <ul class="nav nav-tabs search-page-tabs" id="myTab">
                    <li class="active"><a href="#listTab" data-toggle="tab">{% trans "List View" %}</a></li>
                    <li><a href="#mapTab" data-toggle="tab">{% trans "Map View" %}</a></li>
                </ul>
                <div id="content" class="tab-content">
                    <div class="tab-pane" id="mapTab">
                        {% if hits %}
                           <div id="bagno_map" style="width: 100%; height: 300px"></div>
                        {% else %}
                           <div>{% trans "No results for the given search" %}</div>
                        {% endif %}
                    </div>
                    <div class="tab-pane active" id="listTab">
                        {% if hits %}
                            {%  for hit in hits %}
                                <div class="single-bagno-result-box">
                                    <div class="row">
                                         <div class="col-xs-12">
                                            <h2 class="single-result-header">
                                                <a href="{{ hit.get_absolute_url }}">{{ hit.name }} - {{hit.municipality}}, {{hit.municipality.district}}</a>
                                                {% if hit.distance %}
                                                    <span class="badge">{{hit.distance.km|floatformat:2 }}Km</span>
                                                {% endif %}
                                            </h2>
                                        </div>
                                    </div>
                                    <a href="{{ hit.get_absolute_url }}"><p>{{ hit.address }}, {{ hit.municipality }}</p></a>
                                    {% if hit.services.all %}
                                        {% with hit.services.all|dictsort:"category" as services %}
                                            {% regroup services by category as categorized_services %}
                                            {% for categorized_service in categorized_services %}
                                                <div class="row">
                                                    <div class="col-xs-12"><h4 class="text-underlined">{% trans categorized_service.grouper.name %}</h4></div>
                                                </div>
                                                {% for service_batch in categorized_service.list|batch:4 %}
                                                <div class="row">
                                                    {% for service in service_batch %}
                                                    <div class="col-xs-3">
                                                        <p><span class="glyphicon glyphicon-ok service-glyphicon"></span>  {% trans service.name %}</p>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% endfor %}
                                            {% endfor %}
                                        {% endwith %}
                                    {% else %}
                                        <p><em>{% trans "Facilities information not available" %}</em></p>
                                    {% endif %}
                                </div><hr>
                            {% endfor %}
                            <div class="pagination">
                                <span class="step-links">
                                    {% if hits.has_previous %}
                                        <a href="{% query_string 'p=hits.previous_page_number' 'p' %}">
                                            {% trans "previous" %}
                                        </a>
                                    {% endif %}

                                    <span class="current">
                                        {% blocktrans with num_pages=hits.paginator.num_pages page=hits.number %}Page {{ page }} of {{ num_pages }}.{% endblocktrans %}
                                    </span>

                                    {% if hits.has_next %}
                                        <a href="{% query_string 'p=hits.next_page_number' 'p' %}">
                                            {% trans "next" %}
                                        </a>
                                    {% endif %}
                                </span>
                            </div>
                        {% else %}
                            <div>{% trans "No results for the given search" %}</div>
                        {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block additionaljs %}
    <script type="text/javascript">
	$('#myTab a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
            //TODO: the following should be done only if tab == map
            map.invalidateSize(false);
            map.fitBounds(map_markerBounds);
            //this also results in a nice transition in my opinion (Barto)
            map.zoomOut();
        });
    </script>
{% endblock additionaljs %}

{% block specific_js %}
        <script type="text/javascript">
        var map
        var markerBounds;
        $(function() {
            map = L.map('bagno_map');
            L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
                attribution: 'Data, imagery and map information provided by <a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>, <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors.',
                subdomains: ['otile1','otile2','otile3','otile4'],
                maxZoom: 18
            }).addTo(map);
            map_markerBounds = new L.LatLngBounds();
            {% for bagno in hits %}
                {% if bagno.point.x and bagno.point.y %}
                    var p = new L.LatLng({{ bagno.point.y|unlocalize }}, {{ bagno.point.x|unlocalize }})
                    var marker = L.marker(p).addTo(map);
                    map_markerBounds.extend(p);
                    marker.bindPopup("<strong><a href={{ bagno.get_absolute_url }}>{{ bagno.name }}</a></strong> <em>{{ bagno.address }}</em><br>").openPopup();

                {% endif %}
            {% endfor %}
            map.fitBounds(map_markerBounds);
        });
        </script>
{% endblock specific_js %}

{% block title %}{% trans "Search" %}{% endblock title %}

{% block pagetitle %}{% trans "Search" %}{% endblock pagetitle %}
